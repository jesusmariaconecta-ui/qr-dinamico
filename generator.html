<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Studio — Estilizado (logo PNG + título incrustado)</title>

  <!-- Librería estable que expone window.QRCodeStyling -->
  <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>

  <style>
    :root{--brand:#0b3a75}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f5f7fb;color:#1f2937}
    .container{max-width:980px;margin:32px auto;padding:0 16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:20px}
    h1{font-size:22px;margin:0 0 12px}
    label{display:block;margin:10px 0 4px;color:#374151}
    input,select{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .actions{margin-top:16px;display:flex;gap:10px;flex-wrap:wrap}
    button{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    .preview{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:18px}
    .caption{color:var(--brand);text-align:center;margin-top:8px;font-weight:700}
    .small{color:#6b7280;font-size:12px}
    .slider{display:flex;gap:8px;align-items:center}
    .slider input{flex:1}
    #qr canvas{background:#fff;border-radius:24px}
    #outCanvas{background:#fff;border-radius:24px;max-width:100%}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>QR Studio — Estilizado</h1>
      <p class="small">
        Este generador crea QRs que apuntan a <code>redirect.html?k=…</code> para que sean <strong>dinámicos</strong>.
        Cambias los destinos en <code>target.json</code>. Render en <strong>canvas</strong> y logo <strong>PNG</strong>.
        El <strong>título</strong> se incrusta debajo del QR y queda incluido en el PNG descargado.
      </p>

      <div class="row">
        <div>
          <label>Base URL del redirect (normalmente esta):</label>
          <input id="baseUrl" placeholder="https://TU_USUARIO.github.io/qr-dinamico/redirect.html" />
        </div>
        <div>
          <label>Destino (parámetro <code>k=</code>)</label>
          <select id="key">
            <option value="android">Android (temporal → luego Play)</option>
            <option value="ios">iOS (App Store)</option>
            <option value="web">Web</option>
            <option value="default">Default</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Título debajo del QR (editable)</label>
          <input id="title" placeholder="Jesús María Conecta — App Store (iOS)" />
        </div>
        <div>
          <label>Color del QR</label>
          <input id="color" type="color" value="#0b3a75" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Logo (URL PNG) — centrado</label>
          <input id="logoUrl" placeholder="https://TU_USUARIO.github.io/qr-dinamico/assets/1024-jmc.png" />
          <div class="slider">
            <label style="min-width:110px">Logo %</label>
            <input id="logoPct" type="range" min="10" max="40" step="1" value="28" />
            <span id="logoPctVal">28%</span>
          </div>
        </div>
        <div>
          <label>Tamaño QR (px)</label>
          <input id="size" type="number" value="720" min="256" step="16" />
          <div style="margin-top:10px">
            <label>Esquinas (finder corners)</label>
            <select id="cornerStyle">
              <option value="extra-rounded">Extra redondeadas (tipo “marco”)</option>
              <option value="rounded">Redondeadas</option>
              <option value="square">Cuadradas</option>
            </select>
          </div>
          <div style="margin-top:10px">
            <label>Error correction</label>
            <select id="ecLevel">
              <option value="H">H (recomendado con logos grandes)</option>
              <option value="Q">Q</option>
              <option value="M">M</option>
              <option value="L">L</option>
            </select>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="gen">Generar QR</button>
        <button id="dl" disabled>Descargar PNG</button>
      </div>

      <div class="preview">
        <div>
          <div id="qr" style="display:none"></div>
          <canvas id="outCanvas"></canvas>
          <div class="caption">Previsualización</div>
        </div>
        <div>
          <label>URL final codificada (solo lectura)</label>
          <input id="finalUrl" readonly />
          <p class="small">Tip: añade <code>&show=1</code> al final para ver la redirección sin saltar.</p>
          <p class="small" id="status"></p>
        </div>
      </div>
    </div>
  </div>

<script>
const $ = id => document.getElementById(id);
let qr; // instancia global

function cornerType(val){
  if (val === 'extra-rounded') return 'extra-rounded';
  if (val === 'rounded') return 'rounded';
  return 'square';
}

$('logoPct').addEventListener('input', () => $('logoPctVal').textContent = $('logoPct').value + '%');

function drawCaption(ctx, text, canvasWidth, yStart) {
  // Dibuja el título centrado, con salto de línea automático
  const maxWidth = canvasWidth * 0.9;
  const baseFont = Math.max(18, Math.floor(canvasWidth * 0.045)); // tamaño relativo
  ctx.fillStyle = '#0b3a75';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  ctx.font = '700 ' + baseFont + 'px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif';

  const words = text.trim() ? text.trim().split(/\s+/) : [''];
  let line = '';
  const lines = [];
  for (const w of words) {
    const test = line ? line + ' ' + w : w;
    const m = ctx.measureText(test);
    if (m.width > maxWidth) {
      if (line) lines.push(line);
      line = w;
    } else {
      line = test;
    }
  }
  if (line) lines.push(line);

  // dibujar líneas
  let y = yStart;
  for (const l of lines) {
    ctx.fillText(l, canvasWidth/2, y);
    y += baseFont * 1.25;
  }
  return y - yStart; // alto consumido
}

function composeWithTitle(qrCanvas, title) {
  // Crea un canvas compuesto: QR arriba + título abajo (y algo de margen)
  const qrSize = qrCanvas.width; // cuadrado
  const padding = Math.floor(qrSize * 0.07);
  const captionSpace = Math.floor(qrSize * 0.35); // espacio suficiente para 2-3 líneas
  const out = $('outCanvas');
  out.width  = qrSize + padding * 2;
  out.height = qrSize + padding * 2 + captionSpace;

  const ctx = out.getContext('2d');
  // fondo blanco
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, out.width, out.height);

  // pegar QR centrado
  ctx.drawImage(qrCanvas, padding, padding);

  // título
  const used = drawCaption(ctx, title, out.width, padding + qrSize + Math.floor(qrSize * 0.06));

  // si sobró mucho espacio, no pasa nada; mantenemos alto fijo para consistencia
  return out;
}

$('gen').onclick = async () => {
  const baseDefault = new URL('redirect.html', location.href).toString();
  const base = ($('baseUrl').value.trim() || baseDefault);

  const key   = $('key').value;
  const title = $('title').value.trim() || (key==='ios' ? 'Jesús María Conecta — App Store (iOS)' : 'Jesús María Conecta — Android');
  const color = $('color').value || '#0b3a75';
  const logo  = $('logoUrl').value.trim();       // PNG en el mismo dominio (Pages)
  const size  = Math.max(256, parseInt($('size').value||'720',10));
  const ec    = $('ecLevel').value || 'H';
  const corner= cornerType($('cornerStyle').value);

  const target = base + (base.includes('?') ? '&' : '?') + 'k=' + encodeURIComponent(key);
  $('finalUrl').value = target;

  const opts = {
    width: size,
    height: size,
    type: "canvas",
    data: target,
    image: logo || undefined,
    imageOptions: {
      crossOrigin: "anonymous",
      margin: 2,
      imageSize: (parseInt($('logoPct').value,10) / 100) // 0.10–0.40
    },
    qrOptions: { errorCorrectionLevel: ec },
    dotsOptions: { type: "rounded", color: color },
    cornersSquareOptions: { type: corner, color: color },
    cornersDotOptions: { type: "dot", color: color },
    backgroundOptions: { color: "#ffffff" }
  };

  try {
    if (!qr) {
      qr = new QRCodeStyling(opts);
      $('qr').innerHTML = "";
      qr.append($('qr')); // genera un <canvas> dentro de #qr
    } else {
      qr.update(opts);
    }

    // Espera un ciclo para que el canvas interno esté listo
    await new Promise(r => setTimeout(r, 20));

    const innerCanvas = $('qr').querySelector('canvas');
    if (!innerCanvas) {
      $('status').textContent = 'No se pudo obtener el canvas interno del QR.';
      return;
    }

    // Componer con título y mostrar en outCanvas
    composeWithTitle(innerCanvas, title);
    $('status').textContent = 'QR generado ✔ (con título incrustado)';
    $('dl').disabled = false;
  } catch (e) {
    console.error(e);
    $('status').textContent = 'Error al renderizar el QR. Revisa la ruta del logo o baja el %.';
  }
};

$('dl').onclick = async () => {
  // Descarga el canvas compuesto (QR + título)
  const out = $('outCanvas');
  if (!out || !out.width) return;
  const link = document.createElement('a');
  link.download = 'qr_con_titulo.png';
  link.href = out.toDataURL('image/png');
  link.click();
};

// Valores por defecto al abrir (rutas robustas)
window.addEventListener('load', () => {
  $('baseUrl').value = new URL('redirect.html', location.href).toString();
  $('title').value   = 'Jesús María Conecta — App Store (iOS)';
  $('logoUrl').value = new URL('assets/1024-jmc.png', location.href).toString(); // tu logo PNG por defecto
});
</script>
</body>
</html>





