<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Studio — Estilizado (logo grande + esquinas redondeadas)</title>

  <!-- Librería estable que expone window.QRCodeStyling -->
  <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>

  <style>
    :root{--brand:#0b3a75}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f5f7fb;color:#1f2937}
    .container{max-width:980px;margin:32px auto;padding:0 16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:20px}
    h1{font-size:22px;margin:0 0 12px}
    label{display:block;margin:10px 0 4px;color:#374151}
    input,select{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .actions{margin-top:16px;display:flex;gap:10px;flex-wrap:wrap}
    button{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    .preview{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:18px}
    .caption{color:var(--brand);text-align:center;margin-top:8px;font-weight:700}
    .small{color:#6b7280;font-size:12px}
    .slider{display:flex;gap:8px;align-items:center}
    .slider input{flex:1}
    #qr canvas{background:#fff;border-radius:24px}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>QR Studio — Estilizado</h1>
      <p class="small">
        Este generador crea QRs que apuntan a <code>redirect.html?k=…</code> para que sean <strong>dinámicos</strong>.
        Cambias los destinos en <code>target.json</code>. Usa el logo desde este mismo dominio (Pages) para evitar CORS.
      </p>

      <div class="row">
        <div>
          <label>Base URL del redirect (normalmente esta):</label>
          <input id="baseUrl" placeholder="https://TU_USUARIO.github.io/qr-dinamico/redirect.html" />
        </div>
        <div>
          <label>Destino (parámetro <code>k=</code>)</label>
          <select id="key">
            <option value="android">Android (temporal → luego Play)</option>
            <option value="ios">iOS (App Store)</option>
            <option value="web">Web</option>
            <option value="default">Default</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Título debajo del QR</label>
          <input id="title" placeholder="Jesús María Conecta — App Store (iOS)" />
        </div>
        <div>
          <label>Color del QR</label>
          <input id="color" type="color" value="#0b3a75" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Logo (URL PNG/SVG) — centrado</label>
          <input id="logoUrl" placeholder="https://TU_USUARIO.github.io/qr-dinamico/assets/1024-jmc.png" />
          <div class="slider">
            <label style="min-width:110px">Logo %</label>
            <input id="logoPct" type="range" min="10" max="40" step="1" value="28" />
            <span id="logoPctVal">28%</span>
          </div>
        </div>
        <div>
          <label>Tamaño QR (px)</label>
          <input id="size" type="number" value="720" min="256" step="16" />
          <div class="slider" style="margin-top:10px">
            <label style="min-width:110px">Redondeo módulos</label>
            <input id="dotRound" type="range" min="0" max="1" step="0.05" value="0.85" />
            <span id="dotRoundVal">0.85</span>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Esquinas (finder corners)</label>
          <select id="cornerStyle">
            <option value="extra-rounded">Extra redondeadas (tipo “marco”)</option>
            <option value="rounded">Redondeadas</option>
            <option value="square">Cuadradas</option>
          </select>
        </div>
        <div>
          <label>Error correction</label>
          <select id="ecLevel">
            <option value="H">H (recomendado con logos grandes)</option>
            <option value="Q">Q</option>
            <option value="M">M</option>
            <option value="L">L</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button id="gen">Generar QR</button>
        <button id="dl" disabled>Descargar PNG</button>
      </div>

      <div class="preview">
        <div>
          <div id="qr"></div>
          <div class="caption" id="caption">Previsualización</div>
        </div>
        <div>
          <label>URL final codificada (solo lectura)</label>
          <input id="finalUrl" readonly />
          <p class="small">Tip: añade <code>&show=1</code> al final para ver la redirección sin saltar.</p>
          <p class="small" id="status"></p>
        </div>
      </div>
    </div>
  </div>

<script>
const $ = id => document.getElementById(id);
let qr; // instancia global

function cornerType(val){
  if (val === 'extra-rounded') return 'extra-rounded';
  if (val === 'rounded') return 'rounded';
  return 'square';
}

$('logoPct').addEventListener('input', () => $('logoPctVal').textContent = $('logoPct').value + '%');
$('dotRound').addEventListener('input', () => $('dotRoundVal').textContent = Number($('dotRound').value).toFixed(2));

$('gen').onclick = () => {
  // Base robusta: usa el directorio actual, NO depende del nombre del archivo
  const baseDefault = new URL('redirect.html', location.href).toString();
  const base = ($('baseUrl').value.trim() || baseDefault);

  const key   = $('key').value;
  const title = $('title').value.trim() || (key==='ios' ? 'Jesús María Conecta — App Store (iOS)' : 'Jesús María Conecta — Android');
  const color = $('color').value || '#0b3a75';
  const logo  = $('logoUrl').value.trim();
  const size  = Math.max(256, parseInt($('size').value||'720',10));
  const ec    = $('ecLevel').value || 'H';
  const corner= cornerType($('cornerStyle').value);

  const target = base + (base.includes('?') ? '&' : '?') + 'k=' + encodeURIComponent(key);
  $('finalUrl').value = target;
  $('caption').textContent = title;

  const opts = {
    width: size,
    height: size,
    type: "canvas",
    data: target,
    image: logo || undefined,
    imageOptions: {
      crossOrigin: "anonymous",
      margin: 2,
      imageSize: (parseInt($('logoPct').value,10) / 100) // 0.10–0.40
    },
    qrOptions: { errorCorrectionLevel: ec },
    dotsOptions: { type: "rounded", color: color }, // compatible en todas las builds
    cornersSquareOptions: { type: corner, color },
    cornersDotOptions: { type: "dot", color },
    backgroundOptions: { color: "#ffffff" }
  };

  if (!qr) {
    qr = new QRCodeStyling(opts);
    $('qr').innerHTML = "";
    qr.append($('qr'));
  } else {
    qr.update(opts);
  }

  $('dl').disabled = false;
  $('status').textContent = '';
};

$('dl').onclick = async () => {
  if (!qr) return;
  try {
    await qr.download({ name: "qr_estilizado", extension: "png" });
  } catch (e) {
    $('status').textContent = 'No se pudo descargar el PNG. Revisa permisos del navegador.';
    console.error(e);
  }
};

// Valores por defecto al abrir (rutas robustas)
window.addEventListener('load', () => {
  $('baseUrl').value = new URL('redirect.html', location.href).toString();
  $('title').value   = 'Jesús María Conecta — App Store (iOS)';
  $('logoUrl').value = new URL('assets/1024-jmc.png', location.href).toString(); // tu logo por defecto
});
</script>
</body>
</html>




